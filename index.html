<script>
const DEFAULT_CONFIG = {
  primaryColor: "#b91c1c",
  accentColor: "#facc15",
  zoom: 1,
  separatorColor: "#000000",
  separatorSpacing: 2,
  schoolName: "SENAI",
  tickerText: "",
  slides: []
};

let SYSTEM_CONFIG = {};
let currentSlideIndex = 0;
let slideTimer = null;

async function loadData() {
  try {
    const res = await fetch('data.json?t=' + Date.now());
    if (!res.ok) throw new Error();
    const data = await res.json();
    SYSTEM_CONFIG = normalizeConfig(data);
  } catch {
    SYSTEM_CONFIG = DEFAULT_CONFIG;
  }

  applyGlobalSettings();
  if (!slideTimer) initTV();
  hideLoading();
}

function normalizeConfig(cfg) {
  return {
    ...DEFAULT_CONFIG,
    ...cfg,
    zoom: Number(cfg.zoom) || 1,
    separatorSpacing: Number(cfg.separatorSpacing) || 2,
    slides: Array.isArray(cfg.slides) ? cfg.slides : []
  };
}

function applyGlobalSettings() {
  const r = document.documentElement;
  r.style.setProperty('--primary-color', SYSTEM_CONFIG.primaryColor);
  r.style.setProperty('--accent-color', SYSTEM_CONFIG.accentColor);
  r.style.setProperty('--text-scale', SYSTEM_CONFIG.zoom);
  r.style.setProperty('--separator-color', SYSTEM_CONFIG.separatorColor);
  r.style.setProperty('--separator-spacing', SYSTEM_CONFIG.separatorSpacing + 'rem');

  document.getElementById('display-school-name').innerText = SYSTEM_CONFIG.schoolName;
  document.getElementById('display-ticker').innerHTML =
    (SYSTEM_CONFIG.tickerText || '').replace(/\|/g, '<span class="ticker-separator">â€¢</span>');
}

function initTV() {
  const now = new Date();
  const slides = SYSTEM_CONFIG.slides.filter(s => {
    const start = s.startDate ? new Date(s.startDate) : null;
    const end = s.endDate ? new Date(s.endDate) : null;
    if (start && !isNaN(start) && now < start) return false;
    if (end && !isNaN(end) && now > end) return false;
    return true;
  });

  if (!slides.length) return;

  if (currentSlideIndex >= slides.length) currentSlideIndex = 0;
  const slide = slides[currentSlideIndex];
  renderSlide(slide);

  clearTimeout(slideTimer);
  slideTimer = setTimeout(() => {
    currentSlideIndex++;
    initTV();
  }, (slide.duration || 10) * 1000);
}

function renderSlide(slide) {
  document.getElementById('slide-category').innerText = slide.category || '';
  document.getElementById('slide-title').innerText = slide.title || '';
  document.getElementById('slide-message').innerText = slide.message || '';

  const layout = document.getElementById('main-layout');
  slide.layout === 'fullscreen'
    ? layout.classList.add('layout-fullscreen')
    : layout.classList.remove('layout-fullscreen');

  const media = document.getElementById('media-container');
  media.innerHTML = '';

  let el;
  if (slide.mediaType === 'video') {
    el = document.createElement('video');
    el.src = slide.url;
    el.autoplay = true;
    el.muted = true;
  } else if (slide.mediaType === 'iframe') {
    el = document.createElement('iframe');
    el.src = slide.url;
  } else {
    el = document.createElement('img');
    el.src = slide.url;
  }

  media.appendChild(el);
}

function hideLoading() {
  const l = document.getElementById('loading-overlay');
  if (l) l.remove();
}

loadData();
setInterval(loadData, 30000);
</script>
